# $ skaffold dev: build and deploy your app every time your code changes
# $ skaffold run: build and deploy your app once, similar to a CI/CD pipeline
apiVersion: skaffold/v2beta3
kind: Config
build:
  # to avoid pushing images to the storyscript repository,
  # please set a "default-repo" for skaffold
  # see https://skaffold.dev/docs/environment/image-registries/
  artifacts:
    # please clone the git repos for all artifacts, as required by `context`
    - image: storyscript/auth
      context: ../auth/
    - image: storyscript/language
      context: ../language/
    - image: storyscript/creds
      context: ../creds/
    - image: storyscript/geh
      context: ../geh/
    - image: storyscript/graphql
      context: ../graphql/
    - image: storyscript/http
      context: ../http/
    - image: storyscript/router
      context: ../router/
    - image: storyscript/runtime
      context: ../runtime/
    - image: storyscript/schema
      context: ../database/
    - image: storyscript/sls
      context: ../sls/
    - image: storyscript/studio
      context: ../studio/
      docker:
        dockerfile: ./.docker/Dockerfile.docker
    - image: storyscript/worker
      context: ../worker/
deploy:
  helm:
    releases:
      - name: storyscript
        chartPath: ./
        imageStrategy:
          # our image values use the helm convention
          # i.e. image: { repository, tag }
          helm: {}
        values:
          # skaffold will update these image values (using imageStrategy)
          # to match those generated during the build step
          auth.image: storyscript/auth
          compiler.image: storyscript/language
          creds.image: storyscript/creds
          geh.image: storyscript/geh
          graphql.image: storyscript/graphql
          http.image: storyscript/http
          router.image: storyscript/router
          runtime.image: storyscript/runtime
          schema.image: storyscript/schema
          sls.image: storyscript/sls
          studio.image: storyscript/studio
          worker.image: storyscript/worker
        valuesFiles:
          # please get the values file for your pool env
          # $ helm get values storyscript > values.env.yaml
          - ./values.env.yaml
